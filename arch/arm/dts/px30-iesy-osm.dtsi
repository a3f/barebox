// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Device Tree for iesy RPX30 EVA-MI (Eval Kit)
 *
 * Copyright (c) 2022 iesy GmbH
 */

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/pinctrl/rockchip.h>

#include <arm64/rockchip/px30.dtsi>

/ {
	model = "iesy RPX30 OSM";
	compatible = "iesy,rpx30-osm", "rockchip,px30";

	aliases {
		mmc0 = &sdmmc;
		mmc1 = &emmc;
		mmc2 = &sdio;
	};

        chosen {
        	stdout-path = &uart2;
        };

	vcc5v0_sys: vcc5v0-regulator {
		compatible = "regulator-fixed";
		regulator-name = "vcc5v0_sys";
		regulator-always-on;
		regulator-boot-on;
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
	};

	/* regulator for USB OTG port */
	usb_a_vbus_regulator: usb-a-vbus-regulator {
		compatible = "regulator-fixed";
		regulator-name = "usb_a_vbus_regulator";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		gpio = <&gpio3 RK_PC0 GPIO_ACTIVE_HIGH>;
		enable-active-high;
	};

	/* regulator for USB host port */
	usb_b_vbus_regulator: usb-b-vbus-regulator {
		compatible = "regulator-fixed";
		regulator-name = "usb_b_vbus_regulator";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		gpio = <&gpio3 RK_PC3 GPIO_ACTIVE_HIGH>;
		enable-active-high;
		regulator-always-on;
		regulator-boot-on;
	};

	leds {
		compatible = "gpio-leds";
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_leds_bb138>;

		/* green user led (LD4) on BB138 */
		led-0 {
			label = "USER_LED_00";
			gpios = <&gpio3 RK_PA0 GPIO_ACTIVE_LOW>;
			linux,default-trigger = "heartbeat";
		};

		/* yellow user led (LD9)) on BB138 */
		led-1 {
			label = "USER_LED_01";
			gpios = <&gpio3 RK_PA1 GPIO_ACTIVE_LOW>;
			default-state = "off";
		};
	};
};

&cpu0 {
	cpu-supply = <&vdd_arm>;
};

/* eMMC on CM006 */
&emmc {
	bus-width = <8>;
	cap-mmc-highspeed;
	/* mmc-ddr-1_8v; */
	mmc-hs200-1_8v;
	supports-emmc;
	disable-wp;
	non-removable;
	num-slots = <1>;
	status = "okay";
};

&i2c0 {
	status = "okay";

	rk809: pmic@20 {
		compatible = "rockchip,rk809";
		reg = <0x20>;
		interrupt-parent = <&gpio0>;
		interrupts = <7 IRQ_TYPE_LEVEL_LOW>;
		pinctrl-names = "default";
		pinctrl-0 = <&pmic_int>;
		rockchip,system-power-controller;
		wakeup-source;
		#clock-cells = <1>;
		clock-output-names = "rk808-clkout1", "rk808-clkout2";
		//fb-inner-reg-idxs = <2>;
		/* 1: rst regs (default in codes), 0: rst the pmic */
		pmic-reset-func = <1>;

		vcc1-supply = <&vcc5v0_sys>;
		vcc2-supply = <&vcc5v0_sys>;
		vcc3-supply = <&vcc5v0_sys>;
		vcc4-supply = <&vcc5v0_sys>;
		vcc5-supply = <&vcc3v3_sys>;
		vcc6-supply = <&vcc5v0_sys>;
		vcc7-supply = <&vcc3v3_sys>;
		vcc8-supply = <&vcc5v0_sys>;
		vcc9-supply = <&vcc5v0_sys>;

		pwrkey {
			status = "okay";
		};

		pinctrl_rk8xx: pinctrl_rk8xx {
			gpio-controller;
			#gpio-cells = <2>;

			rk817_slppin_null: rk817_slppin_null {
				pins = "gpio_slp";
				function = "pin_fun0";
			};

			rk817_slppin_slp: rk817_slppin_slp {
				pins = "gpio_slp";
				function = "pin_fun1";
			};

			rk817_slppin_pwrdn: rk817_slppin_pwrdn {
				pins = "gpio_slp";
				function = "pin_fun2";
			};

			rk817_slppin_rst: rk817_slppin_rst {
				pins = "gpio_slp";
				function = "pin_fun3";
			};
		};

		regulators {
			vdd_logic: DCDC_REG1 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <900000>;
				regulator-max-microvolt = <1100000>;
				regulator-ramp-delay = <6001>;
				regulator-initial-mode = <0x2>;
				regulator-name = "vdd_logic";
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <950000>;
				};
			};

			vdd_arm: DCDC_REG2 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <950000>;
				regulator-max-microvolt = <1350000>;
				regulator-ramp-delay = <6001>;
				regulator-initial-mode = <0x2>;
				regulator-name = "vdd_arm";
				regulator-state-mem {
					regulator-off-in-suspend;
					regulator-suspend-microvolt = <950000>;
				};
			};

			vcc_ddr: DCDC_REG3 {
				regulator-always-on;
				regulator-boot-on;
				regulator-name = "vcc_ddr";
				regulator-initial-mode = <0x2>;
				regulator-state-mem {
					regulator-on-in-suspend;
				};
			};

			vcc3v3_sys: DCDC_REG5 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;
				regulator-name = "vcc3v3_sys";
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <3300000>;
				};
			};

			vcc_1v0: LDO_REG1 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <1000000>;
				regulator-max-microvolt = <1000000>;
				regulator-name = "vcc_1v0";
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <1000000>;
				};
			};

			vcc1v8_soc: LDO_REG2 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <1800000>;

				regulator-name = "vcc1v8_soc";
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <1800000>;
				};
			};

			vdd1v0_soc: LDO_REG3 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <1000000>;
				regulator-max-microvolt = <1000000>;

				regulator-name = "vcc1v0_soc";
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <1000000>;
				};
			};

			vcc3v0_pmu: LDO_REG4 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;

				regulator-name = "vcc3v0_pmu";
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <3300000>;

				};
			};

			vccio_sd: LDO_REG5 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <3300000>;

				regulator-name = "vccio_sd";
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <3300000>;
				};
			};

			vcc2v8_dvp: LDO_REG7 {
				regulator-min-microvolt = <2800000>;
				regulator-max-microvolt = <2800000>;

				regulator-name = "vcc2v8_dvp";
				regulator-state-mem {
					regulator-off-in-suspend;
					regulator-suspend-microvolt = <2800000>;
				};
			};

			vcc1v8_dvp: LDO_REG8 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <1800000>;

				regulator-name = "vcc1v8_dvp";
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <1800000>;
				};
			};

			vdd1v5_dvp: LDO_REG9 {
				regulator-min-microvolt = <1500000>;
				regulator-max-microvolt = <1500000>;

				regulator-name = "vdd1v5_dvp";
				regulator-state-mem {
					regulator-off-in-suspend;
					regulator-suspend-microvolt = <1500000>;
				};
			};

			vcc5v0_host: SWITCH_REG1 {
				regulator-name = "vcc5v0_host";
			};

			vcc3v3_lcd: SWITCH_REG2 {
				regulator-name = "vcc3v3_lcd";
			};
		};
	};

	/* LM75 sensor on BB138 */
	sensor@4e {
		status = "okay";
		compatible = "lm75";
		reg = <0x4e>;
	};

	/* EEPROM on BB138 */
	eeprom@51 {
		status = "okay";
		compatible = "atmel,24c64";
		reg = <0x51>;
		pagesize = <32>;
	};
};

&io_domains {
	status = "okay";

	vccio1-supply = <&vcc1v8_dvp>;
	vccio2-supply = <&vccio_sd>;
	vccio3-supply = <&vcc1v8_dvp>;
	vccio4-supply = <&vcc1v8_dvp>;
	vccio5-supply = <&vcc1v8_dvp>;
	vccio6-supply = <&vcc1v8_soc>;
	pmuio1-supply = <&vcc3v0_pmu>;
	pmuio2-supply = <&vcc1v8_soc>;
};

&pmu_io_domains {
	status = "okay";

	pmuio1-supply = <&vcc3v0_pmu>;
	pmuio2-supply = <&vcc1v8_soc>;
};

&saradc {
	vref-supply = <&vcc1v8_soc>;
};

&sdmmc {
	bus-width = <4>;
	cap-mmc-highspeed;
	cap-sd-highspeed;
	supports-sd;
	card-detect-delay = <800>;
	ignore-pm-notify;
	/*cd-gpios = <&gpio2 4 GPIO_ACTIVE_HIGH>; [> CD GPIO <]*/
	sd-uhs-sdr12;
	sd-uhs-sdr25;
	sd-uhs-sdr50;
	sd-uhs-sdr104;
	max-frequency = <135000000>;
};

/* used for reading gpu temperature */
&tsadc {
	pinctrl-names = "gpio", "otpout";
	pinctrl-0 = <&tsadc_otp_gpio>;
	pinctrl-1 = <&tsadc_otp_out>;
	status = "okay";
};

&u2phy_host {
	phy-supply = <&vcc3v0_pmu>;
	vbus-supply = <&usb_b_vbus_regulator>;
	pinctrl-0 = <&u2phy_host_pin>;
};

&u2phy_otg {
	phy-supply = <&vcc3v0_pmu>;
	vbus-supply = <&usb_a_vbus_regulator>;
	pinctrl-0 = <&u2phy_otg_pin>;
};

&spi1 {
	cs-gpios = <&gpio3 RK_PB0 GPIO_ACTIVE_LOW>;
};

/*
 * Inserted to avoid error messages
 * "Looking up ...-supply property in node /power-management@ff000000/power-controller failed"
 * @MAS: Are the specified power domains correct?
 */
&power {
	pd_vi-supply = <&vdd_logic>;
	pd_vpu-supply = <&vdd_logic>;
	pd_gpu-supply = <&vdd_logic>;
	pd_usb-supply = <&vdd_logic>;
};

&pinctrl {
	pmic {
		pmic_int: pmic_int {
			rockchip,pins =
				<0 RK_PA7 RK_FUNC_GPIO &pcfg_pull_up>;
		};
	};

	leds {
		pinctrl_leds_bb138: pinctrl-leds-bb138 {
			rockchip,pins =
				<3 RK_PA0 RK_FUNC_GPIO &pcfg_pull_none>,
				<3 RK_PA1 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};

	uart0 {
		uart0_xfer: uart0-xfer {
			rockchip,pins =
				<0 RK_PB2 1 &pcfg_pull_none_2ma>,
				<0 RK_PB3 1 &pcfg_pull_up>;
		};

		uart0_rts: uart0-rts {
			rockchip,pins =
				<0 RK_PB5 1 &pcfg_pull_none_2ma>;
		};
	};

	uart1 {
		uart1_xfer: uart1-xfer {
			rockchip,pins =
				<1 RK_PC1 1 &pcfg_pull_none_2ma>,
				<1 RK_PC0 1 &pcfg_pull_up>;
		};

		uart1_rts: uart1-rts {
			rockchip,pins =
				<1 RK_PC3 1 &pcfg_pull_none_2ma>;
		};
	};

	uart2-m1 {
		uart2m1_xfer: uart2m1-xfer {
			rockchip,pins =
				<2 RK_PB4 2 &pcfg_pull_up>,
				<2 RK_PB6 2 &pcfg_pull_up_2ma>;
		};
	};

	gpio_bb138 {
		pinctrl_gpio_a: pinctrl-gpio-a {
			rockchip,pins =
				<1 RK_PC4 RK_FUNC_GPIO &pcfg_pull_none>,
				<1 RK_PC5 RK_FUNC_GPIO &pcfg_pull_up_4ma>,
				<1 RK_PC6 RK_FUNC_GPIO &pcfg_pull_up_4ma>,
				<1 RK_PC7 RK_FUNC_GPIO &pcfg_pull_up_4ma>,
				<1 RK_PD0 RK_FUNC_GPIO &pcfg_pull_up_4ma>,
				<1 RK_PD1 RK_FUNC_GPIO &pcfg_pull_up_4ma>,
				<3 RK_PD0 RK_FUNC_GPIO &pcfg_pull_none>,
				<3 RK_PD1 RK_FUNC_GPIO &pcfg_pull_none>;
		};

		pinctrl_gpio_b: pinctrl-gpio-b {
			rockchip,pins =
				<3 RK_PA0 RK_FUNC_GPIO &pcfg_pull_none_2ma>,
				<3 RK_PA1 RK_FUNC_GPIO &pcfg_pull_none_2ma>,
				<3 RK_PA2 RK_FUNC_GPIO &pcfg_pull_up_2ma>,
				<3 RK_PA3 RK_FUNC_GPIO &pcfg_pull_up_2ma>,
				<3 RK_PA4 RK_FUNC_GPIO &pcfg_pull_up_2ma>,
				<3 RK_PA5 RK_FUNC_GPIO &pcfg_pull_up_2ma>,
				<3 RK_PA6 RK_FUNC_GPIO &pcfg_pull_up_2ma>,
				<3 RK_PA7 RK_FUNC_GPIO &pcfg_pull_up_2ma>;
		};
	};

	pwm1 {
		pwm1_pin: pwm1-pin {
			rockchip,pins =
				<0 RK_PC0 1 &pcfg_pull_none_2ma>;
		};
	};

	pwm2 {
		pwm2_pin: pwm2-pin {
			rockchip,pins =
				<2 RK_PB5 1 &pcfg_pull_none_2ma>;
		};
	};

	pwm3 {
		pwm3_pin: pwm3-pin {
			rockchip,pins =
				<0 RK_PC1 1 &pcfg_pull_none_2ma>;
		};
	};

	spi1 {
		/* spi1.sdo */
		spi1_mosi: spi1-mosi {
			rockchip,pins =
				<3 RK_PB4 4 &pcfg_pull_none>;
		};

		/* spi1.csn PIN E17 used! */
		spi1_csn: spi1-csn {
			rockchip,pins =
				<3 RK_PB0 4 &pcfg_pull_none>;
		};

		spi1_clk: spi1-clk {
			rockchip,pins =
				<3 RK_PB7 4 &pcfg_pull_none>;
		};
	};

	u2phy {
		u2phy_host_pin: host-port {
			rockchip,pins =
				<3 RK_PC3 1 &pcfg_pull_none_4ma>;
		};

		u2phy_otg_pin: otg-port {
			rockchip,pins =
				<3 RK_PC0 1 &pcfg_pull_none_4ma>;
		};
	};
};

/* DON'T PUT ANYTHING BELOW HERE.  PUT IT ABOVE PINCTRL */
